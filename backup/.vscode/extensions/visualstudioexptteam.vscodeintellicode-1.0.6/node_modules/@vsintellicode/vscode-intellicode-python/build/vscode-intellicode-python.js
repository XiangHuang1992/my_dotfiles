"use strict";
/*! Copyright (c) Microsoft Corporation. All rights reserved. */
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const vscode = __importStar(require("vscode"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const genericErrorMessage = "Cannot start IntelliCode support for Python. See output window for more details.";
const minModelSchemaVersion = 2;
const maxModelSchemaVersion = 2;
class PythonSupport {
    getRequestedConfig() {
        return [{
                scopeName: "python",
                settingName: "jediEnabled",
                desiredValue: false,
                required: true,
                scopesToTry: [
                    vscode.ConfigurationTarget.Global,
                    vscode.ConfigurationTarget.Workspace,
                    vscode.ConfigurationTarget.WorkspaceFolder
                ],
                reloadWindowAfterApplying: true,
                notificationMessage: "IntelliCode Python support requires you to use the Microsoft Python Language Server (preview).",
                actionLabel: "Enable it and Reload Window"
            }];
    }
    async activate(api, logger) {
        let model = await api.ModelAcquisitionService
            .getModelProvider("PythonIntellicode", "Completions", minModelSchemaVersion, maxModelSchemaVersion, [])
            .getModelAsync(undefined);
        if (model === undefined) {
            logger("No model available for Python, cannot continue.");
            return Promise.resolve();
        }
        let modelJson = JSON.stringify(model);
        logger(`vs-intellicode-python was passed a model: ${modelJson}.`);
        let assemblyPath = path_1.default.join(__dirname, "IntellicodeForPython.dll");
        try {
            fs_1.default.accessSync(assemblyPath, fs_1.default.constants.F_OK);
        }
        catch (err) {
            logger(`Python Language Server extension assembly doesn't exist in ${assemblyPath}. Please reinstall IntelliCode.`);
            return Promise.reject(err);
        }
        const pythonExtension = vscode.extensions.getExtension("ms-python.python");
        if (!pythonExtension) {
            const err = "Microsoft Python extension is not installed.";
            logger(err);
            return Promise.reject(err);
        }
        if (!pythonExtension.isActive) {
            const api = await pythonExtension.activate();
            await api.ready;
        }
        let command = vscode.commands.executeCommand("python._loadLanguageServerExtension", {
            assembly: assemblyPath,
            typeName: "Microsoft.PythonTools.Analysis.Pythia.LanguageServerExtensionProvider",
            properties: {
                modelPath: model.modelPath
            }
        });
        if (command == null) {
            logger("Couldn't find language server extension command. Is the installed version of Python 2018.7.0 or later?");
            return Promise.reject(new Error(genericErrorMessage));
        }
        await command;
        logger("Loaded language server extension.");
        return Promise.resolve();
    }
}
exports.PythonSupport = PythonSupport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidnNjb2RlLWludGVsbGljb2RlLXB5dGhvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy92c2NvZGUtaW50ZWxsaWNvZGUtcHl0aG9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxnRUFBZ0U7Ozs7Ozs7Ozs7OztBQUVoRSwrQ0FBaUM7QUFFakMsZ0RBQXdCO0FBQ3hCLDRDQUFvQjtBQUVwQixNQUFNLG1CQUFtQixHQUFXLGtGQUFrRixDQUFDO0FBQ3ZILE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFBO0FBQy9CLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFBO0FBRS9CO0lBRUksa0JBQWtCO1FBQ2QsT0FBTyxDQUFDO2dCQUNKLFNBQVMsRUFBRSxRQUFRO2dCQUNuQixXQUFXLEVBQUUsYUFBYTtnQkFDMUIsWUFBWSxFQUFFLEtBQUs7Z0JBQ25CLFFBQVEsRUFBRSxJQUFJO2dCQUNkLFdBQVcsRUFBRTtvQkFDVCxNQUFNLENBQUMsbUJBQW1CLENBQUMsTUFBTTtvQkFDakMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFNBQVM7b0JBQ3BDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlO2lCQUM3QztnQkFDRCx5QkFBeUIsRUFBRSxJQUFJO2dCQUMvQixtQkFBbUIsRUFBRSxnR0FBZ0c7Z0JBQ3JILFdBQVcsRUFBRSw2QkFBNkI7YUFDN0MsQ0FBQyxDQUFDO0lBRVAsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBcUIsRUFBRSxNQUE0QjtRQUU5RCxJQUFJLEtBQUssR0FBc0MsTUFBTSxHQUFHLENBQUMsdUJBQXVCO2FBQzNFLGdCQUFnQixDQUFDLG1CQUFtQixFQUFFLGFBQWEsRUFBRSxxQkFBcUIsRUFBRSxxQkFBcUIsRUFBRSxFQUFFLENBQUM7YUFDdEcsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlCLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUNyQixNQUFNLENBQUMsaURBQWlELENBQUMsQ0FBQztZQUMxRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUM1QjtRQUVELElBQUksU0FBUyxHQUFZLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0MsTUFBTSxDQUFDLDZDQUE2QyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBRWxFLElBQUksWUFBWSxHQUFXLGNBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLDBCQUEwQixDQUFDLENBQUM7UUFDNUUsSUFBSTtZQUNBLFlBQUUsQ0FBQyxVQUFVLENBQUMsWUFBWSxFQUFFLFlBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbEQ7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE1BQU0sQ0FBQyw4REFBOEQsWUFBWSxpQ0FBaUMsQ0FBQyxDQUFDO1lBQ3BILE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUM5QjtRQUlELE1BQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDM0UsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUNsQixNQUFNLEdBQUcsR0FBRyw4Q0FBOEMsQ0FBQztZQUMzRCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDWixPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDOUI7UUFHRCxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRTtZQUMzQixNQUFNLEdBQUcsR0FBRyxNQUFNLGVBQWUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM3QyxNQUFNLEdBQUcsQ0FBQyxLQUFLLENBQUM7U0FDbkI7UUFFRCxJQUFJLE9BQU8sR0FBNkIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMscUNBQXFDLEVBQUU7WUFDMUcsUUFBUSxFQUFFLFlBQVk7WUFDdEIsUUFBUSxFQUFFLHVFQUF1RTtZQUNqRixVQUFVLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO2FBQzdCO1NBQ0osQ0FBQyxDQUFDO1FBRUgsSUFBSSxPQUFPLElBQUksSUFBSSxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyx3R0FBd0csQ0FBQyxDQUFDO1lBQ2pILE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7U0FDekQ7UUFFRCxNQUFNLE9BQU8sQ0FBQztRQUNkLE1BQU0sQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1FBQzVDLE9BQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzdCLENBQUM7Q0FDSjtBQTFFRCxzQ0EwRUMifQ==